---
title: "Read a FBM from a file"
author: "Florian Priv√©"
date: "July 2, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(bigstatsr)
```

In this vignette, you will learn how to read a Filebacked Big Matrix from a text file. 
We will see how to use function `big_read` through examples. **This function is far from perfect, any help improving it would be appreciated.**

## First example

### Store a fake file

```{r}
N <- 10 
M <- 5
(x <- matrix(rnorm(N * M), nrow = N, dimnames = list(letters[1:N], LETTERS[1:M])))
csv <- tempfile(fileext = ".csv")
data.table::fwrite(cbind.data.frame(L = letters[1:N], x), csv, quote = FALSE, sep = " ")
```

### Get some intuition on the file format

I think it is always a good idea to print the first lines of the file you are interested in reading.
```{r}
substr(readLines(csv, 3), 0, 60)
```

What you can see with these first 3 lines:

- the first line of the file stores some names (header),
- the first element of all following lines stores also some names,
- the elements are separated by a space, 
- the elements are doubles.

### Read the file

```{r}
# See how the options corresponds to what we have seen 
# when reading the first 3 lines of the file
test <- big_read(csv, header = TRUE, sep = " ", 
                 nlines = N + 1, confirmed = TRUE)
```

```{r}
str(test)
```

### Understand the resulting object

There are at least 2 things to note:

1. where are the names?
  
    - rownames are stored in `$meta` information
    
    - colnames are stored in `$colnames`

    ```{r}
    (rownames <- test$meta$L)
    (colnames <- test$colnames)
    ```

    
2. the resulting matrix is stored in `$FBM`. If you want this FBM to be used in another session later, **make sure to specify the `backingfile` and `save = TRUE`**.

    ```{r}
    str(test$FBM)
    ```

## Second example

### A larger dataset

```{r}
big_iris <- do.call("rbind", rep(list(iris), 1000))
dim(big_iris)
```

```{r}
csv <- tempfile(fileext = ".csv")
data.table::fwrite(big_iris, csv, quote = FALSE)
```

### Get some intuition on the file format

```{r}
readLines(csv, 5)
```

What you can see with these first 2 lines:

- there is a header,
- the first 4 columns seems numeric but not the last one,
- the elements are separated by commas.

### Read the matrix

```{r}
str(test <- big_read(csv, header = TRUE, sep = ",", 
                     nlines = 150000 + 1, confirmed = TRUE))
```
