<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting penalized regressions • bigstatsr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting penalized regressions">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bigstatsr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Manual</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://privefl.github.io/R-presentation/bigstatsr.html">Introduction to package bigstatsr</a>
    </li>
    <li>
      <a href="https://privefl.github.io/bigsnpr/articles/exo.html">Exercise</a>
    </li>
    <li>
      <a href="../articles/bigstatsr-and-bigmemory.html">Packages bigstatsr and bigmemory</a>
    </li>
    <li>
      <a href="../articles/operations-with-scaling.html">Operations with scaling</a>
    </li>
    <li>
      <a href="../articles/read-FBM-from-file.html">Read a FBM from a text file</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://privefl.github.io/about.html">
    <span class="fa fa-user"></span>
     
    About
  </a>
</li>
<li>
  <a href="https://github.com/privefl/bigstatsr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Fitting penalized regressions</h1>
                        <h4 class="author">Florian Privé</h4>
            
            <h4 class="date">May 22, 2019</h4>
      
      
      <div class="hidden name"><code>penalized-regressions.Rmd</code></div>

    </div>

    
    
<p>In R package {bigstatsr}, you can fit efficient penalized (linear and logistic) regressions using functions <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code>. Similar implementation of Cox regression is an area of future development.</p>
<p>You might want to look at the corresponding paper and cite it:</p>
<p>Privé, Florian, Hugues Aschard, and Michael GB Blum. “Efficient implementation of penalized regression for genetic risk prediction.” Genetics (2019). [<a href="https://doi.org/10.1534/genetics.119.302019">Open access</a>]</p>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>To illustrate how to use <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code>, let us use some simulated data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(bigstatsr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1</span>)

<span class="co"># simulating some data</span>
N &lt;-<span class="st"> </span><span class="dv">530</span>
M &lt;-<span class="st"> </span><span class="dv">730</span>
X &lt;-<span class="st"> </span><span class="kw"><a href="../reference/FBM-class.html">FBM</a></span>(N, M, <span class="dt">init =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(N <span class="op">*</span><span class="st"> </span>M, <span class="dt">sd =</span> <span class="dv">5</span>))
y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">rowSums</a></span>(X[, <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>]) <span class="op">+</span><span class="st"> </span><span class="dv">20</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(N)

ind.train &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sort">sort</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(X), <span class="dv">400</span>))
ind.test &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sets">setdiff</a></span>(<span class="kw"><a href="../reference/seq-dim.html">rows_along</a></span>(X), ind.train)</code></pre></div>
</div>
<div id="cross-model-selection-and-averaging-cmsa" class="section level2">
<h2 class="hasAnchor">
<a href="#cross-model-selection-and-averaging-cmsa" class="anchor"></a>Cross-Model Selection and Averaging (CMSA)</h2>
<p>Functions <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code> automatically perform a procedure similar to cross-validation to choose hyper-parameters <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(\alpha\)</span> of the elastic net regularization:</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/privefl/paper2-PRS/master/figures/simple-CMSA.png" alt='Illustration of one turn of the Cross-Model Selection and Averaging (CMSA) procedure. First, this procedure separates the outer training set (blue *and* red) in K folds (e.g. 10 folds). Secondly, in turn, each fold is considered as an inner validation set (red) and the other (K - 1) folds form an inner training set (blue). A "regularization path" of models is trained on the inner training set and the corresponding predictions (scores) for the inner validation set are computed. The model that minimizes the loss on the inner validation set is selected.  Finally, the K resulting models are averaged. We also use this procedure to derive an early stopping criterion so that the algorithm does not need to evaluate the whole regularization paths, making this procedure much faster than standard cross-validation.' width="70%"><p class="caption">
Illustration of one turn of the Cross-Model Selection and Averaging (CMSA) procedure. First, this procedure separates the outer training set (blue <em>and</em> red) in K folds (e.g. 10 folds). Secondly, in turn, each fold is considered as an inner validation set (red) and the other (K - 1) folds form an inner training set (blue). A “regularization path” of models is trained on the inner training set and the corresponding predictions (scores) for the inner validation set are computed. The model that minimizes the loss on the inner validation set is selected. Finally, the K resulting models are averaged. We also use this procedure to derive an early stopping criterion so that the algorithm does not need to evaluate the whole regularization paths, making this procedure much faster than standard cross-validation.
</p>
</div>
<div id="sequences-of-hyper-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#sequences-of-hyper-parameters" class="anchor"></a>Sequences of hyper-parameters</h3>
<ul>
<li><p>The first (maximum) value of the lambda sequence (<span class="math inline">\(\lambda_{max}\)</span>) is computed automatically and corresponds to enough regularization to have no variable entering the model. Then, a sequence of <code>nlambda</code> (200 by default) values is used, equally spaces on a log-scale between <span class="math inline">\(\lambda_{max}\)</span> and <span class="math inline">\(\lambda_{max}\)</span> * <code>lambda.min</code>.</p></li>
<li><p>A sequence of <span class="math inline">\(\alpha\)</span> can be defined by the user using <code>alphas</code> (default is <code>1</code>). We recommend to use a grid on a log-scale (e.g. <code>10^(-(0:4))</code>).</p></li>
</ul>
</div>
<div id="stopping-criterion-for-regularization-path" class="section level3">
<h3 class="hasAnchor">
<a href="#stopping-criterion-for-regularization-path" class="anchor"></a>Stopping criterion for regularization path</h3>
<p>There are three main reasons for which regularization paths can end:</p>
<ul>
<li><p>the current model include too many non-zero variables (<code>dfmax</code> equals <code>50e3</code> by default, you can use <code>Inf</code>)</p></li>
<li><p>the early stopping criterion is reached, which means that models are getting worse for the inner validation set; you can control this using <code>nlam.min</code> (the minimal number of <span class="math inline">\(\lambda\)</span> values to try before stopping) and <code>n.abort</code> (the number of <span class="math inline">\(\lambda\)</span> values for which the model is getting worse)</p></li>
<li><p>the <code>nlambda</code> <span class="math inline">\(\lambda\)</span> values have been used; you might want to reduce <code>lambda.min</code> to go further down the path</p></li>
</ul>
<p>It is possible to fit the <code>K</code> folds for each value of <code>alphas</code> in parallel using parameter <code>ncores</code>.</p>
<p>You <em>should</em> check why regularization paths stop. For this, you can use both methods <code><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot()</a></code> and <code><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary()</a></code>. Let us make an example below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mod &lt;-<span class="st"> </span><span class="kw"><a href="../reference/big_spLinReg.html">big_spLinReg</a></span>(X, y[ind.train], <span class="dt">ind.train =</span> ind.train, <span class="dt">K =</span> <span class="dv">4</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(mod)</code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   alpha validation_loss intercept beta        nb_var message  
##   &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt; &lt;list&gt;       &lt;int&gt; &lt;list&gt;   
## 1     1           1647.     -2.09 &lt;dbl [730]&gt;    355 &lt;chr [4]&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(mod)<span class="op">$</span>message</code></pre></div>
<pre><code>## [[1]]
## [1] "No more improvement" "No more improvement" "No more improvement"
## [4] "No more improvement"</code></pre>
<p>Here, <code>"No more improvement"</code> means that the early stopping criterion has been reached. We can see the validation loss getting worse at some point:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(mod)</code></pre></div>
<p><img src="penalized-regressions_files/figure-html/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;"></p>
<p>For small datasets, you might want to reduce the number of folds (<code>K</code> = 10 bu default). For large datasets, you might want to decrease <code>n.abort</code> (i.e. stop the regularization path quickly) as the path is usually much more smooth and fitting is more and more demanding as we advance along the regularization path (because more and more variables are used in the model).</p>
<p>Use <code><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict()</a></code> to use the model for data in the test set:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(mod, X, ind.test)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(pred, y[ind.test], <span class="dt">pch =</span> <span class="dv">20</span>); <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="penalized-regressions_files/figure-html/unnamed-chunk-5-1.png" width="70%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="other-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#other-parameters" class="anchor"></a>Other parameters</h2>
<ul>
<li><p>You can add covariates as a standard R matrix using parameter <code>covar.train</code>; it will fit the model as if <code>X[ind.train, ]</code> and <code>covar.train</code> were <code>cbind</code>ed.</p></li>
<li><p>You can add an offset to your model using <code>base.train</code> (on the linear scale, do not provide probabilities!).</p></li>
<li><p>You can apply some multiplicative penalization factors (<code>pf.X</code> and <code>pf.covar</code>) to penalize variables differently (possibly no penalization for <em>some</em> variables using <code>0</code>).</p></li>
<li><p>Functions <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code> are not deterministic because folds are chosen randomly. One way that should ensure reproducibility is to define your own folds using parameter <code>ind.sets</code> (using e.g. <code><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample(rep_len(1:K, length(ind.train)))</a></code>).</p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data">Data</a></li>
      <li><a href="#cross-model-selection-and-averaging-cmsa">Cross-Model Selection and Averaging (CMSA)</a></li>
      <li><a href="#other-parameters">Other parameters</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Florian Privé.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
